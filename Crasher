-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- CHARACTER
local function getChar()
	return player.Character or player.CharacterAdded:Wait()
end

-- GUI
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.Name = "LagGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.38, 0.22)
frame.Position = UDim2.fromScale(0.31, 0.39)
frame.BackgroundColor3 = Color3.fromRGB(22,22,22)
frame.Active = true

Instance.new("UICorner", frame).CornerRadius = UDim.new(0,18)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.fromScale(1,0.3)
title.BackgroundTransparency = 1
title.Text = "Lag Server"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true

local button = Instance.new("TextButton", frame)
button.Position = UDim2.fromScale(0.15,0.45)
button.Size = UDim2.fromScale(0.7,0.4)
button.Text = "Lag Server: OFF"
button.BackgroundColor3 = Color3.fromRGB(40,40,40)
button.TextColor3 = Color3.new(1,1,1)
button.Font = Enum.Font.Gotham
button.TextScaled = true
Instance.new("UICorner", button).CornerRadius = UDim.new(0,14)

-- DRAG PC + MOBILE
local dragging, dragStart, startPos
frame.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = i.Position
		startPos = frame.Position
	end
end)

frame.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(i)
	if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local delta = i.Position - dragStart
		frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
								   startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- LAG LOGIC
local lagEnabled = false
local fpsDelay = 0.06 -- ~15 FPS start
local fpsConn
local tpConn

local function fakeKick()
	gui:Destroy()
	task.wait(0.2)
	player:Kick("Disconnected: Server crashed")
end

button.MouseButton1Click:Connect(function()
	lagEnabled = not lagEnabled

	if lagEnabled then
		button.Text = "Lag Server: ON"
		fpsDelay = 0.06

		-- FPS FAKE LAG
		fpsConn = RunService.RenderStepped:Connect(function()
			task.wait(fpsDelay)
			fpsDelay = math.clamp(fpsDelay + 0.0008, 0.06, 0.18) -- bis ~5 FPS
		end)

		-- RUBBERBAND MOVEMENT
		tpConn = RunService.Heartbeat:Connect(function()
			local char = getChar()
			local hrp = char:FindFirstChild("HumanoidRootPart")
			local hum = char:FindFirstChild("Humanoid")

			if hrp and hum and hum.MoveDirection.Magnitude > 0 then
				local backOffset = hrp.CFrame.LookVector * -math.random(1,3)
				hrp.CFrame = hrp.CFrame + backOffset * 0.15
			end
		end)

		-- RANDOM FAKE CRASH
		task.spawn(function()
			wait(math.random(15,20))
			if lagEnabled then
				if fpsConn then fpsConn:Disconnect() end
				if tpConn then tpConn:Disconnect() end
				fakeKick()
			end
		end)

	else
		button.Text = "Lag Server: OFF"
		if fpsConn then fpsConn:Disconnect() end
		if tpConn then tpConn:Disconnect() end
	end
end)
